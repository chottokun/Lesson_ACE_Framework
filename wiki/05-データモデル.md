# 🗄️ 5. データモデル

ACE Frameworkは、データの永続化と高速なセマンティック検索のために、**SQLite** と **FAISS** を組み合わせて使用しています。

## 1. 長期記憶 (Long-Term Memory)

### SQLite: `documents` テーブル
検索されたドキュメントのメタデータと全文を保存します。
また、FTS5 (Full-Text Search) 拡張を使用してキーワード検索を高速化しています。

| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | INTEGER | プライマリキー (自動インクリメント) |
| `content` | TEXT | 学習・抽出された知識の本文 |
| `entities` | TEXT | 関連するエンティティ (JSON形式) |
| `problem_class` | TEXT | 抽象化された問題クラス |
| `timestamp` | DATETIME | 作成日時 (デフォルト: CURRENT_TIMESTAMP) |

**実装コード参照:**
- `(../src/ace_rm/memory/core.py:44-59)`

### FAISS: ベクトルインデックス
`documents` テーブルの `content` カラムを埋め込みベクトル化し、高速な類似度検索を可能にします。

- **インデックス形式**: `IndexIDMap` (IDとベクトルのマッピングを保持)
- **距離指標**: L2 (デフォルト) または Cosine (設定による)
- **埋め込みモデル**: sentence-transformers

**実装コード参照:**
- `(../src/ace_rm/memory/core.py:61-104)`

## 2. タスクキュー (Task Queue)

バックグラウンドでの非同期学習プロセスを管理するためのキューです。

### SQLite: `task_queue` テーブル

| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | INTEGER | プライマリキー |
| `user_input` | TEXT | ユーザーの入力メッセージ |
| `agent_output` | TEXT | エージェントの応答メッセージ |
| `status` | TEXT | タスク状態 (`pending`, `processing`, `done`, `failed`) |
| `retries` | INTEGER | 再試行回数 |
| `error_msg` | TEXT | エラー発生時のメッセージ |
| `created_at` | DATETIME | タスク登録日時 |
| `updated_at` | DATETIME | 最終更新日時 |

**実装コード参照:**
- `(../src/ace_rm/memory/queue.py:23-35)`

## 3. ストレージ・モード

### Shared Mode
全ユーザーが `ace_memory.db` と `ace_memory.faiss` を共有します。システム全体で一つの頭脳を持つイメージです。

### Isolated Mode
ユーザーセッションごとに独立したファイルが `user_data/` に作成されます。
- DB: `user_data/ace_memory_{session_id}.db`
- FAISS: `user_data/ace_memory_{session_id}.faiss`

---
詳細は [コアコンポーネント](./06-コアコンポーネント.md) を参照してください。
