# ⚡ 9. デプロイメントと最適化

ACE Frameworkは、高負荷な推論環境でも安定して動作するように設計されています。

## パフォーマンス最適化

### 1. バッチ挿入 (30倍の高速化)
`ACE_Memory.add_batch` メソッドにより、大量の知識を一度に登録する際のパフォーマンスが大幅に向上しました。
- **最適化前**: ドキュメントごとにDBトランザクションとFAISSの更新が発生。
- **最適化後**: 単一のトランザクション内でDB書き込み、一括エンコーディング、一括インデックス更新を実行。これにより、1ドキュメントあたりの挿入時間が約31msから1ms未満に短縮されています。

**実装コード参照:**
- `(../src/ace_rm/memory/core.py:122-157)`

### 2. リソース共有 (メモリ消費の削減)
エージェント（同期処理）とバックグラウンドワーカー（非同期処理）が、同一の埋め込みモデル・インスタンスを共有します。
- **EmbeddingManager**: `get_embedding_model` によるシングルトン・パターンを採用し、モデルの二重ロードを防止。
- **効果**: 同時実行時のRAM使用量を約50%削減。

**実装コード参照:**
- `(../src/ace_rm/utils/embedding_manager.py:1-29)`

### 3. ハードウェア・アクセラレーション
FAISSは、利用可能な場合に自動的に GPU (CUDA) を使用するように設計されています。
- `.env` の `ACE_DEVICE` を設定することで、明示的に `cpu` または `cuda` を指定可能です。

## デプロイメント構成

### マルチユーザー・モードの選択

| モード | ユースケース | 保存場所 |
| :--- | :--- | :--- |
| **Shared** (デフォルト) | 組織全体で知識を共有する場合 | プロジェクトルート (`ace_memory.db`) |
| **Isolated** | ユーザーごとの個人用アシスタントの場合 | `user_data/ace_memory_{session_id}.db` |

### 拡張性 (ChromaDB Ready)
現在の実装では `ACE_Memory` クラスにおいて SQLite と FAISS を組み合わせていますが、インターフェースが抽象化されているため、将来的に ChromaDB などのベクトルデータベースへ移行することが容易です。

## 安定性の確保
- **ファイルロック**: `filelock` ライブラリを使用して、複数のプロセス/スレッドが同時に FAISS インデックスに書き込む際の競合を防いでいます。
- **WALモード**: SQLite の `journal_mode=WAL` を有効にすることで、読み書きの並行性を高めています。

---
詳細は [コントリビューションガイド](./10-コントリビューションガイド.md) を参照してください。
