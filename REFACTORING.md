# リファクタリングドキュメント

## 1. 目的

本ドキュメントは、`ace_framework.py` を中心に行われたコードリファクタリングの目的、変更点、およびその検証プロセスを詳述するものです。このリファクタリングの主な目的は、コードベースの **可読性、保守性、拡張性** を向上させることでした。

当初、主要なロジックが単一のファイル (`ace_framework.py`) に集中しており、機能の追加や修正が困難になるリスクがありました。そこで、関心の分離（Separation of Concerns）の原則に基づき、各機能コンポーネントを独立したモジュールに分割しました。

---

## 2. リファクタリング項目と考え方

### 2.1. 主要ロジックのモジュール化

最も大きな変更点は、`ace_framework.py` ファイルを機能ごとに複数の小さなファイルに分割したことです。

-   **`memory.py`**:
    -   **役割**: `ACE_Memory` クラスを格納。SQLiteデータベースとFAISSベクターストアの操作、タスクキューの管理など、エージェントの長期記憶に関するすべての永続化ロジックを担当します。
    -   **考え方**: データ永続化層をアプリケーションのコアロジックから分離することで、将来的にデータベースの種類を変更したり、インデックス戦略を改善したりする際に、影響範囲をこのファイル内に限定できます。

-   **`worker.py`**:
    -   **役割**: `BackgroundWorker` クラスを格納。タスクキューから対話ログを取得し、LLMによる非同期の分析・学習処理を実行するバックグラウンドスレッドを担当します。
    -   **考え方**: 同期的な対話処理と非同期的な学習処理を明確に分離しました。これにより、バックグラウンド処理のロジックが複雑化しても、ユーザー応答性に影響を与えることなく開発を進められます。

-   **`graph.py`**:
    -   **役割**: `build_ace_agent` 関数と、`LangGraph` を用いたエージェントの認知サイクル（Curator, Agent, Reflectorノード）の定義を担当します。
    -   **考え方**: エージェントの思考プロセスやワークフローの定義を一つのファイルに集約することで、処理の流れを追いやすくなります。ノードの追加や条件分岐の変更も、このファイル内で行うことができます。

-   **`typing.py`**:
    -   **役割**: `AgentState` のような、複数のモジュール間で共有される型定義（`TypedDict`）を格納します。
    -   **考え方**: 型情報を一元管理することで、コードの静的解析性が向上し、状態オブジェクトの構造が変更された場合でも、修正箇所が明確になります。

### 2.2. 設定と定数の一元管理

ハードコードされた値や設定情報をコード全体から抽出し、専用のファイルに集約しました。

-   **`config.py`**:
    -   **役割**: `.env` ファイルから環境変数（APIキー、モデル名、LTMモードなど）を読み込み、アプリケーション全体で使用する設定値を一元的に提供します。
    -   **考え方**: 設定情報を一箇所にまとめることで、デプロイ環境ごとに異なる設定を適用するのが容易になります。コード内から環境変数への直接アクセスをなくし、設定の出所を明確にしました。

-   **`constants.py`**:
    -   **役割**: タスクのステータス名 (`"pending"`, `"done"`) や、埋め込み生成時のプレフィックス文字列のような、コード内で繰り返し使用される「マジックストリング（魔法の文字列）」を定数として定義します。
    -   **考え方**: 文字列の打ち間違いによるバグを防ぎ、コードの意図をより明確にするために導入しました。

### 2.3. 共通ユーティリティの集約

-   **`utils.py`**:
    -   **役割**: 複数のモジュールで重複して定義されていた `call_llm_with_retry` 関数を格納します。
    -   **考え方**: DRY (Don't Repeat Yourself) の原則に従い、共通のヘルパー関数を分離しました。これにより、リトライ戦略などを変更する際に、一箇所の修正で済むようになります。

---

## 3. テストと検証

リファクタリングは、既存の機能を壊さないことが大前提です。そのため、変更の各段階で既存のテストスイートを実行し、デグレード（機能低下）が発生していないことを慎重に確認しました。

### 3.1. 自動テスト

プロジェクトに整備されていた自動テストを実行し、すべてのテストがパスすることを確認しました。

-   **実行コマンド**: `uv run pytest`
-   **結果**: **全テスト項目（8項目）が成功。**
-   **内容**: このテストスイートには、`ACE_Memory` の基本的なCRUD操作、`BackgroundWorker` のタスク処理ロジック（成功・失敗ケース）、`LangGraph` のビルド検証などが含まれており、リファクタリングによる影響が最も大きいコアコンポーネントの動作を保証しています。

### 3.2. 手動エンドツーエンドテスト

自動テストだけではカバーしきれない、システム全体の連携を確認するため、手動のテストスクリプトを実行しました。

-   **実行コマンド**: `uv run python tests/manual_test_memory_flow.py`
-   **結果**: **テストは成功。**
-   **内容**: このテストは、エージェントの認知ループ全体（学習→知識の保存→検索→応用）をシミュレートするものです。具体的には、「水差し問題」を解かせ、その解法を一般化して記憶させ、次に類似の問題を提示した際に、記憶した知識を正しく検索して応用できることを確認しました。これにより、モジュール間の連携がリファクタリング後も正常に機能していることを検証しました。

---

## 4. リファクタリングによる効果

-   **保守性の向上**: 各モジュールの役割が明確になったため、コードの理解が容易になり、将来の機能追加やバグ修正が迅速に行えるようになりました。
-   **再利用性の向上**: `memory` や `utils` のようなコンポーネントは、他のプロジェクトでも再利用できる可能性があります。
-   **テストの容易性**: 機能が疎結合になったことで、各モジュールを独立してテストしやすくなりました。
